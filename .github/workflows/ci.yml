name: CI

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install linting tools
        run: |
          pip install ruff mypy

      - name: Run ruff
        run: ruff check src/ tests/ --output-format=github

      - name: Run mypy
        run: mypy src/bsad/ --ignore-missing-imports || true

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

  smoke-benchmark:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .

      - name: Run smoke benchmark
        run: |
          # Quick demo to verify pipeline works
          python -c "
          import sys
          sys.path.insert(0, 'src')
          from bsad.config import Settings
          from bsad import steps

          # Minimal settings for CI
          settings = Settings(
              n_entities=20,
              n_days=7,
              attack_rate=0.05,
              n_samples=100,
              n_tune=50,
              n_chains=1,
              random_seed=42
          )

          print('Generating data...')
          events_df, attacks_df = steps.generate_data(settings)
          print(f'Events: {len(events_df)}')

          print('Building features...')
          modeling_df, metadata = steps.build_features(events_df, attacks_df, settings)
          print(f'Observations: {len(modeling_df)}')

          print('Training model (minimal)...')
          arrays = steps.get_model_arrays(modeling_df)
          trace = steps.train_model(arrays, settings)

          print('Scoring...')
          scores = steps.compute_scores(arrays['y'], trace, arrays['entity_idx'])

          print('Evaluating...')
          intervals = steps.compute_intervals(trace, arrays['entity_idx'])
          scored_df = steps.create_scored_df(modeling_df, scores, intervals)
          metrics = steps.evaluate(scored_df)

          print(f'PR-AUC: {metrics[\"pr_auc\"]:.3f}')
          print('Smoke test passed!')
          "

      - name: Run baseline comparison
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'src')
          from bsad.baselines import run_all_baselines
          import numpy as np

          # Minimal test
          y = np.random.poisson(5, 100)
          entity_idx = np.repeat(np.arange(10), 10)

          results = run_all_baselines(y, entity_idx, include_generic=False)
          print(f'Baselines tested: {list(results.keys())}')
          print('Baseline smoke test passed!')
          "
